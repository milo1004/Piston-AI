<!DOCTYPE html>
    <html>
        <head>
            <title>
                Piston AI
            </title>
            <link rel="icon" type="image/png" href="src/AI.png">
            <style>
                @font-face {
                    font-family: "MiSans";
                    src: url("MiSansRegular.ttf") format("truetype");
                }

                body, html {
                    overflow: hidden;
                    height: 100%;                
                }

                * {
                    margin: 0;
                    font-family: "MiSans", sans-serif;
                    color: white;
                    user-select: none;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                }

                body {
                    display: flex;
                    visibility: hidden;
                    background-color: #050505;
                    margin: 3%;
                    justify-content: center;
                    overflow: hidden;
                    overscroll-behavior-y: none;
                }

                .greeting-h2 {
                    font-size: 3em;
                    position: absolute;
                    font-weight: 400;
                }

                body.blur-active > *:not(#setUp-container) {
                    filter: blur(5px);
                    pointer-events: none;
                }

                .setUp-container {
                    visibility: hidden;
                    position: absolute;
                    border: 2px solid gray;
                    border-radius:  10%;
                    margin: 5%;
                    align-items: center;
                    background-color: #363636;
                    border: 2px solid gray;
                    border-radius: 10px;
                    padding: 1.5em;
                    box-shadow: 0 0 20px rgba(0,0,0,0.8);
                    z-index: 1000;
                    justify-content: center;
                    align-items: center;
                    padding: 5%
                }

                #setup-input {
                    border: 2px solid gray;
                    border-radius: 10px;
                    margin-top: 1.5em;
                    height: 2em;
                    color: white;
                    background-color: #000000;
                    padding-left: 3%;
                }

                #setup-done-btn {
                    border: none;
                    border-radius: 10px;
                    margin-top: 1.5em;
                    background-color: #0080ff;
                    width: 4em;
                    height: 2em;
                    color: white;
                    cursor: pointer;
                    font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                    padding-right: 4%;
                }

                .credit {
                    color: gray; font-size: x-small; position: fixed; bottom: 4px;
                }

                .credit:hover {
                    text-decoration: underline; cursor: pointer;
                }

                .tc {
                    border-radius: 10px;
                    border: 2px solid gray;
                    display: flex;
                    justify-content: center;
                    position: absolute;
                    padding-left: 1em;
                    padding-right: 1em;
                    top: 10%;
                    left: 10%;
                    background-image: linear-gradient(rgb(47,47,47), rgb(0,0,0));
                    flex-direction: column;
                }

                .h1-time {
                    font-size: 5em;
                    font-weight: 300;
                } 

                #temp {
                    font-size: 5em;
                    font-weight: 300;
                    color: #a6ff01;
                    margin-bottom: 10px;
                }

                .weather {
                    border-radius: 10px;
                    border: 2px solid gray;
                    display: flex;
                    justify-content: center;
                    position: absolute;
                    padding-left: 1em;
                    padding-right: 1em;
                    top: 10%;
                    right: 10%;
                    background-image: linear-gradient(rgb(47, 47, 47), rgb(0,0,0));
                    flex-direction: column;
                }

                .startSTT {
                    border: 2px solid gray;
                    border-radius: 10em;
                    position: absolute;
                    bottom: 10px;
                    right: 10px;
                    height: 45px;
                    width: 45px;
                    background-size: cover;
                    background-color: #000000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    transition: 
                        background-color 0.2s ease,
                        opacity 0.2s ease;
                }

                #sendBtn {
                    border: 2px solid gray;
                    border-radius: 10em;
                    position: absolute;
                    bottom: 10px;
                    height: 40px;
                    width: 40px;
                    background-size: cover;
                    background-color: #000000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    transition: 
                        background-color 0.2s ease,
                        opacity 0.2s ease;
                    z-index: 7;
                    opacity: 100%;
                }

                #sendBtn:hover {
                    cursor: pointer;
                    background-color: gray;
                }

                #sendBtn:disabled {
                    cursor: not-allowed;
                    opacity: 20%;
                }

                .startSTT:hover {
                    cursor: pointer;
                    background-color: gray;
                }

                .startSTT:disabled {
                    cursor: not-allowed;
                    opacity: 20%;
                }

                .abortSTT {
                    border: 2px solid gray;
                    border-radius: 10em;
                    position: absolute;
                    bottom: 10px;
                    right: 10px;
                    height: 45px;
                    width: 45px;
                    background-size: cover;
                    background-color: #000000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    transition:
                        background-color 0.2s ease,
                        opacity 0.2s ease;
                    visibility: hidden;
                }

                .abortSTT:hover {
                    background-color: gray;
                    cursor: pointer;
                }

                #speechRecDiv {
                    display: flex;
                    flex-direction: column;
                }

                #SRHint {
                    background-color: white;
                    border: 3px ;
                    visibility: visible;
                    color: black;
                    border-radius: 3px;
                    padding: 3px;
                    position: absolute;
                    right: 10px;
                    visibility: hidden;

                    transform: translateY(5px);

                    transition: 
                        opacity 0.25s ease,
                        transform 0.25s ease;
                }

                #SRHint.show {
                    opacity: 1;
                    visibility: visible;
                    transform: translateY(0);
                    z-index: 1000;
                }

                #AIbox {
                    border: 1px solid gray;
                    border-radius: 20px;
                    padding-left: 5%;
                    padding-right: 5%;
                    visibility: hidden;
                    display: flex;
                    flex-direction: column;
                    position: absolute;
                    justify-content: center;
                    align-items: center;
                    overflow-y: auto;
                    z-index: 5;
                    width: 30%;
                    height: 50%;
                    background-image: linear-gradient(rgb(47,), rgb(0,0,0));
                    transition: 
                        background-color 0.2s ease,
                        transform 0.2s ease;
                    overscroll-behavior-y: auto;
                    overscroll-behavior-x: none;
                }

                #AIbox:hover {
                    cursor: pointer;
                    background-color: gray;
                }

                #manIn {
                    border: 2px solid gray;
                    border-radius: 10em;
                    position: absolute;
                    bottom: 10px;
                    width: 25em;
                    height: 50px;
                    padding-left: 10px;
                    color: black;
                    z-index: 6;
                    box-sizing: border-box;
                    transition:
                        opacity 0.2s ease;
                }

                #manIn:disabled {
                    cursor: not-allowed;
				}

                #alarmBox {
                    border: 2px solid gray;
                    border-radius: 20px;
                    width: 20em;
                    display: flex;
                    flex-direction: column;
                    position: absolute;
                    background-color: black;
                    align-items: center;
					height: 50%;
					width: 20%;
					overflow-x: hidden;
					overflow-y: hidden;
                }
            
				#alarmPrompt {
					display: flex;
					background-color: gray;
                    border-bottom: 2px solid gray;
                    position: absolute;
                    align-items: center;
					width: 100%;
					height: 2em;
					justify-content: center;
                }

				#createAlarm {
					background-color: gray;
					border: none;
					border-radius: 10px;
					position: absolute;
					transition:
						background-color 0.2s ease;
					opacity: 100%;
					width: 30px;
					height: 30px;
					display: flex;
					align-items: center;
					justify-content: center;
				}

				#createAlarm:hover {
					background-color: black;
					cursor: pointer;
				}

				#alarmsContainer {
					display: flex;
					flex-direction: column;
					overflow-y: auto;
					position: absolute;
				}

                #alarmsRepeated {
                    display: flex;
                    flex-direction: column;
                    overflow-x: hidden;
                    position: absolute;
                    visibility: hidden;
                    background-color: white;
                    border-radius: 3em;
                    transition: opacity 0.2s ease;
                }

                .repeatOpt {
                    background-color: white;
                    border-radius: 3em;
                    transition: background-color 0.2s ease;
                }

                .repeatOpt:hover {
                    background-color: gray;
                    cursor: pointer;
                }
            </style>
        </head>
        <body>
            <h1 class="greeting-h2" id="greeting">
                Welcome back!
            </h1>
            <div class="setUp-container" id="setUp-container">
                <h3>Setup Piston AI</h3>
                <p><br>What should we call you?</p>
                <input type="text" id="setup-input" value="" placeholder="Your name here">
                <br>
                <input type="button" value="Done :&#41 " id="setup-done-btn" onclick="setupDone()">
                <p id="setup-warning" style="color: red; font-size: x-small; margin-top: 0.5em; visibility: hidden; z-index: 1001;"></p>
            </div>
            <div id="tc" class="tc">
                <div style="display: flex; margin-bottom:10px;">            
                    <h1 id="hour" class="h1-time">--</h1>
                    <h1 class="h1-time" id="colon">:</h1>
                    <h1 id="minute" class="h1-time">--</h1>
                </div>
                <div id="dc" style="display: flex; flex-direction: row; ">
                    <h1 id="weekday" style="color: #a6ff01">--</h1>
                    <div>&nbsp&nbsp</div>
                    <h1 id="date">--</h1>
                </div>
            </div>
            <div id="weather" class="weather">
                <h1 class="h1-time" id="temp">--Â°C</h1>
                <div style="display: flex; flex-direction: row;" id="weatherInfo">
                    <img src="src/noData.png" id="weatherData" draggable="false">
                    <h1>&nbsp</h1>
                    <h1 id="weatherText" style="font-weight: 600">No data</h1>
                </div>
            </div>

            <div id="speechRecDiv">
                <div id="SRHint">
                    <p id="SRHintTxt" style="color: black">Press to start speech recognition</p>
                </div>
                <button class="startSTT" id="startSTT" onclick="">
                    <img id="startSTTImg" src="src/STT.png" style="height: 80%;" draggable="false">
                </button>
                <input id="manIn" placeholder="Ask Piston AI">
                <button class="startSTT" id="sendBtn">
                    <img id="sendBtnImg" src="src/send.png" style="height: 80%;" draggable="false">
                </button> 
                <button id="abortSTT" class="abortSTT">
                    <img src="src/abort.png" draggable="false" style="height: 80%">
                </button>
            </div>
            <div id="AIbox"></div>
            <div id="alarmBox">
                <div id="alarmPrompt">
                    <p id="promptText">Alarms</p>
					<button id="createAlarm">
						<img id="createImg" src="src/add.png" alt="Create" width=25 height=25>
					</button>
                </div>
				<div id="alarmsContainer"></div>
                <div id="alarmsRepeated">
                    <button id="repeatedSun">
                        <img>
                    </button>
                </div>
			</div>
            <p class="credit" onclick="redirectToGitHub()">Brought to you by Milo Chan</p>
            <script>
                const SRBtnEl = document.getElementById("startSTT");
                let chunks = [];
                let stream = null;
                let medRecorder = null;
                let recordState = false;
                let AIboxout = true;
                const AIboxElTemp = document.getElementById("AIbox");
                AIboxElTemp.onclick = modAIBox;

                function handleInput() {
                    const manInEl = document.getElementById("manIn");
                    const sendBtnEl = document.getElementById("sendBtn");
                    const startSTTEl = document.getElementById("startSTT");

                    if (manInEl.value.trim() === "") {
                        sendBtnEl.disabled = true;
                        sendBtnEl.style.opacity = "20%";
           				startSTTEl.disabled = false;
                        startSTTEl.style.opacity = "100%";
                    } else if (manInEl.value.trim() !== "") {
                        sendBtnEl.disabled = false;
                        sendBtnEl.style.opacity = "100%";
                        startSTTEl.disabled = true;
                        startSTTEl.style.opacity = "20%";
                    }
                }

                function handleEnter(e) {
                    const manInEl = document.getElementById("manIn");
                    const sendBtnEl = document.getElementById("sendBtn");
                    const startSTTEl = document.getElementById("startSTT")
                    if (e.key == "Enter") {
                        e.preventDefault();
                        if (manInEl.value.trim() !== "") {
                            askPiston(manInEl.value);
                            manInEl.value = "";
                            sendBtnEl.disabled = true;
                            sendBtnEl.style.opacity = "20%";
                            startSTTEl.disabled = false;
                            startSTTEl.style.opacity = "100%";
                            return;
                        }
                    }
                }

                function positionManIn() {

                    const manInEl = document.getElementById("manIn");
                    const sendBtnEl = document.getElementById("sendBtn");
                    const startSTTEl = document.getElementById("startSTT");

						manInEl.style.left = startSTTEl.offsetLeft - 5 - manInEl.offsetWidth + 'px';
						manInEl.style.bottom = 10 + 'px';
                    sendBtnEl.style.left = startSTTEl.offsetLeft - 5 - sendBtnEl.offsetWidth - 8 + 'px';
                    const rel_borders = (manInEl.offsetHeight - sendBtnEl.offsetHeight) / 2;
                    sendBtnEl.style.top = manInEl.offsetTop + rel_borders + 'px';
                    manInEl.style.paddingRight = 8 + sendBtnEl.offsetWidth + 5 + 'px';
                    manInEl.style.width = parseFloat(getComputedStyle(manInEl).fontSize) * 25 - parseFloat(manInEl.style.paddingRght) + 'px';
                    if (manInEl.value === "") {
                        sendBtnEl.disabled = true;
                        startSTTEl.disabled = false;
                    } else if (manInEl.value.trim() !== "") {
                        sendBtnEl.disabled = false;
                        startSTTEl.disabled = true;
                    }

                    manInEl.removeEventListener("input", handleInput);
                    manInEl.addEventListener("input", handleInput);
                    
                    manInEl.removeEventListener("keydown", handleEnter);
                    manInEl.addEventListener("keydown", handleEnter);
                }

                function modAIBox() {
                    const weatherEl = document.getElementById("weather");
                    const AIboxEl = document.getElementById("AIbox");

                    if (AIboxout === true) {
                        const target_y = window.innerHeight - AIboxEl.offsetHeight * 0.2;
                        const rel_y = target_y - AIboxEl.offsetTop;
                        AIboxEl.style.transform = `translate(0, ${rel_y}px)`;
                        AIboxout = false;
                    } else if (AIboxout === false) {
                        const target_y = weatherEl.offsetTop + weatherEl.offsetHeight + 10;
                        const rel_y = target_y - AIboxEl.offsetTop;
                        AIboxEl.style.transform = `translate(0, ${rel_y}px)`;
                        AIboxout = true;
                    }
                }
                async function requestMic() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log("Microphone access granted!");
                    } catch (e) {
                        if (e.name === "NotAllowedError" || e === "PermissionDeniedError") {
                            alert("Microphone permission has been denied.");
                        } else if (e.name === "NotFoundError") {
                            alert("Warning: Microphone not found. Make sure a microphone has been connected properly.");
                            var micNotFound = true;
                        } else {
                            alert("getUserMedia failed: ",e.name,e.message);
                            console.error(e);
                        }
                        const SRHintEl = document.getElementById("SRHint");
                        SRHintEl.style.visibility = "hidden";   
                    }
                }

                async function checkMicPerm() {
                    const permissionStat = await navigator.permissions.query({ name: "microphone" });
                    console.log(`Microphone permission state = ${permissionStat.state}`);
                    if (permissionStat.state === "granted") {
                        return 0;
                    } else if (permissionStat.state === "denied") {
                        return 1;
                    } else if (permissionStat.state === "prompt") {
                        return 2;
                    }
                }

                function modManIn(hide) {
                    const manInEl = document.getElementById("manIn");
                    const sendBtnEl = document.getElementById("sendBtn");
                    if (hide) {
                        manInEl.style.opacity = 0;
                        sendBtnEl.style.opacity = 0;
                        manInEl.disabled = true;
                        setTimeout(() => {
                            manInEl.style.visibility = "hidden";
                            sendBtnEl.style.visibility = "hidden";
                        }, 200);
                    } else if (!hide) {
                        manInEl.style.visibility = "visible";
                        sendBtnEl.style.visibility = "visible";
                        manInEl.style.opacity = 100;
                        sendBtnEl.style.opacity = 100;
                        manInEl.disabled = false;
                        if (manInEl.value === "") {
                            sendBtnEl.disabled = true;
                            sendBtnEl.style.opacity = "20%";
                        } else {
                            sendBtnEl.disabled = false; 
                            sendBtnEl.style.opacity = "100%";
                        }
                    }
                }

                function showAbort() {
                    const abortSTTEl = document.getElementById("abortSTT");
                    const startSTTEl = document.getElementById("startSTT");;

                    abortSTTEl.style.visibility = "visible";
                    const target_x = -5 - abortSTTEl.offsetWidth + 'px';

                    abortSTTEl.style.transform = `translate(${target_x}, 0)`;
                    setTimeout(() => {}, 200);
                    abortSTTEl.style.opacity = "100%";
                    abortSTTEl.disabled = false;

                    abortSTTEl.onclick = stopSTT;
                }

                function hideAbort() {
                    const abortSTTEl = document.getElementById("abortSTT");
                    const startSTTEl = document.getElementById("startSTT");;

                    abortSTTEl.style.opacity = "100%";

                    const target_x = startSTTEl.offsetLeft - abortSTTEl.offsetLeft + 'px';

                    abortSTTEl.style.transform = `translate(${target_x}, 0)`;
                    abortSTTEl.style.visibility = "hidden";
                    abortSTTEl.style.disabled = true;
                }

                async function startRecording() {
                    if (medRecorder?.state === "recording") {
                        console.log("Already recording");
                        recordState = true;
                        return;
                    } 
                    recordState = true;
                    modRecordBtn();
                    SRBtnEl.removeEventListener("mouseout", removeHint);
                    const SRHintEl = document.getElementById("SRHint");
                    const SRHintTxtEl = document.getElementById("SRHintTxt");
                    SRHintEl.style.visibility = "visible";
                    showAbort();
                    SRHintTxtEl.textContent = "Listening...";
                    try {
                        medRecorder = new MediaRecorder(stream, {
                            mimeType: "audio/webm;codecs=opus",
                            audioBitsPerSecond: 128000
                        });
                        chunks = [];
                        
                        medRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                chunks.push(event.data);
                            }
                        };

                        medRecorder.start();
                        console.log("Listening");
                        modManIn(true);

                    } catch (e) {
                        console.error("Error listenting: ",e);
                        recordState = false;
                        modRecordBtn();
                        SRBtnEl.addEventListener("mouseout",removeHint);
                        SRHintTxtEl.textContent = "Press to start speech recognition";
                    }
                }

                function modRecordBtn() {
                    const startSTTEl = document.getElementById("startSTTImg");
                    if (recordState === true) {
                        startSTTEl.src = "src/STT'ing.png";
                    } else if (recordState === false) {
                        startSTTEl.src = "src/STT.png"
                    }
                }

                function positionAIBox() {
                    const AIboxEl = document.getElementById("AIbox");
                    const weatherEl = document.getElementById("weather");

                    AIboxEl.style.top = (weatherEl.offsetTop + weatherEl.offsetHeight) + 10 + 'px';
                    AIboxEl.style.left = (window.innerWidth - AIboxEl.offsetLeft) / 2; 

                    const historyMsg = JSON.parse(localStorage.getItem("history"));

                   	if (historyMsg === null) return;
					
					if (historyMsg.length === 0) return;
                    for (let i = 0; i < historyMsg.length; i++) {
                        if (historyMsg[i].role == "user") {
                            const userIn = document.createElement("p");
                            userIn.style.color = "white";
                            userIn.style.userSelect = "text";
                            userIn.style.cursor = "text";
                            userIn.textContent = `You: ${historyMsg[i].content}`;
                            AIboxEl.appendChild(userIn);
                        } else if (historyMsg[i].role === "assistant") {
                            const pisRes = document.createElement("p");
                            pisRes.style.color = "#a6ff01";
                            pisRes.style.marginTop = "5px";
                            pisRes.style.userSelect = "text";
                            pisRes.style.cursor = "text";
                            pisRes.textContent = historyMsg[i].content;
                            AIboxEl.appendChild(pisRes);
                            const lineBreak = document.createElement("br");
                            lineBreak.style.lineHeight = 2.0;
                            AIboxEl.appendChild(lineBreak);
                        }

                    }
                    AIboxEl.style.visibility = "visible";
                    AIboxout = false;
                    modAIBox();
                }

                async function stopRecording() {
                    if (!medRecorder || medRecorder.state !== "recording") {
                        recordState = false;
                        console.warn("No active recording to stop.");
                        modRecordBtn();
                        return;
                    }

                    recordState = false;
                    modRecordBtn();
                    medRecorder.stop();
                    modManIn(false);
                    positionAIBox();
                    const SRHintEl = document.getElementById("SRHint");
                    const SRHintTxtEl = document.getElementById("SRHintTxt");
                    AIboxout = false;
                    modAIBox();
                    SRHintEl.style.visibility = "visible";
                    hideAbort();
                    SRHintTxtEl.textContent = "Transcribing...";
                    await new Promise(resolve => {
                        medRecorder.onstop = resolve;
                    })
                    const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append("audio", audioBlob, "recording.webm")
                    const res = await fetch("https://backend.chanyanyan3205.workers.dev/", {
                        method: "POST",
                        body: formData
                    });
                    const data = await res.json();
                    SRHintTxtEl.textContent = "Asking Piston AI...";
                    const reponse = await askPiston(data.text);
                    SRHintTxtEl.textContent = "Press to start recognition";
                    SRHintEl.style.visibility = "hidden";
                    SRBtnEl.addEventListener("mouseout", removeHint);
                }

                function saveHistory(roles, message) {
                    let previousMessage = JSON.parse(localStorage.getItem("history"));
                    if (!previousMessage) {
                        previousMessage = [];
                    }
                    const payload = {
                        role: roles,
                        content: message
                    }
                    previousMessage.push(payload);
                    localStorage.setItem("history", JSON.stringify(previousMessage));

                    if (previousMessage.length > 50 * 2) {
                        previousMessage.shift();
                        previousMessage.shift();
                        localStorage.setItem("history", JSON.stringify(previousMessage));
                        return;
                    }
                }

                function removeHint() {
                    document.getElementById("SRHint").classList.remove("show");
                    clearTimeout(hintTimer);
                }

                window.addEventListener("resize", () => {
                    positionHint();
                    alignClock();
                    positionClock();
                    positionWeather();
                    getLocation();
                    positionManIn();
                    positionAbort();
                    positionAIBox();
                    positionClock();
                    if (createAlarmInProgress) {
                        createAlarmFunc();
                    }
                })

                const setupInputEl = document.getElementById("setup-input");
                setupInputEl.addEventListener("keydown", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        setupDone();
                    }
                });

                SRBtnEl.addEventListener("mouseover", () => {
                    hintTimer = setTimeout(() => {
                        const SRHintEl = document.getElementById("SRHint");
                        SRHintEl.classList.add("show");
                    }, 500);
                });

                SRBtnEl.addEventListener("mouseout", removeHint);

                SRBtnEl.onclick = async () => {
                    let micPerm;
                    micPerm = await checkMicPerm();
                    if (micPerm === 0) {
                    } else if (micPerm === 1) {
                        alert("Microphone access has been denied. Please grant it in browser setings or system settings.");
                        return;
                    } else if (micPerm === 2) {
                        requestMic();
                        micPerm = checkMicPerm();
                        if (micPerm === 1) {
                            alert("Warning: Microphon access has been denied. Grant it in browser to use Piston AI.");
                        } else if (micPerm === 0) {
                            console.log("Microphone access granted!");
                            return;
                        }
                    }

                    if (recordState === false) {
                        startRecording();
                    } else {
                        stopRecording();
                    }
                    
                }

                const sendBtnEl = document.getElementById("sendBtn");
                sendBtnEl.onclick = () => {
                    const manInEl = document.getElementById("manIn");
                    const startSTTEl = document.getElementById("startSTT");
                    response = askPiston(manInEl.value);
                    manInEl.value = "";
                    sendBtnEl.disabled = true;
                    startSTTEl.disabled = false;
                }

                async function askPiston(uInput) {
                    const AIboxEl = document.getElementById("AIbox");
                    try {
                        AIboxEl.style.visibility = "visible";

                        let historyMsg = localStorage.getItem("history");
                        if (!historyMsg) {
                            historyMsg = [];
                        } else {
                            historyMsg = JSON.parse(historyMsg);
                        }
                        
                        const clearPromptEl = document.getElementById("clearPrompt");
                        if (clearPromptEl) {
                            clearPromptEl.remove();
                            const brEl = AIbox.querySelectorAll("br");
                            brEl.forEach(br => {
                                br.parentNode.removeChild(br);
                            })
                        }
                        const uInputEl = document.createElement("p");
                        uInputEl.style.color = "white";
                        uInputEl.style.userSelect = "text";
                        uInputEl.style.cursor = "text";
                        uInputEl.textContent = `You: ${uInput}`;
                        AIboxEl.appendChild(uInputEl); 

                        let memory = `You have access to the memory below: \n The user's name is ${localStorage.getItem("username")}`;
                        const now = new Date();
                        let AdditionalData = `Additional data: \nweather data:${localStorage.getItem("weatherData")}\ndate (DD/MM/YYYY): ${now.getDate().toString().padStart(2,"0")}/${now.getMonth().toString().padStart(2,"0")}/${now.getFullYear}\ntime (hour:minute): ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}`;
                        const result = await fetch("https://piston-ai.chanyanyan3205.workers.dev", {
                            method: "POST",
                            headers: {
                                "Content-Type":"application/json"
                            },
                            body: JSON.stringify({
                                history: historyMsg,
                                prompt: `${memory}\n\n${AdditionalData}\n\nUser input: ${uInput}`
                            })
                        });
                        if (!result.ok) {
                            throw `POST https://chanyanyan3205.cloudflare.com/ ${result.statusText}`;
                        }
                        saveHistory(role="user", message=uInput);
                        const response = await result.json();
                        saveHistory(role="assistant", message=response.reply);
                           
                        if (response.reply.includes("chat.clear")) {
                            localStorage.setItem("history", "[]");
                            response.reply = "Chat cleared! Let's start fresh";
                            document.getElementById("AIbox").innerHTML = "";
                            const linebreak = document.createElement("br");
                            linebreak.style.lineHeight = 2.0;
                            AIboxEl.appendChild(linebreak);
                        }

                        if (response.reply === "Chat cleared! Let's start fresh") {
                            const pisRes = document.createElement("p");
                            pisRes.style.color = "#a6ff01";
                            pisRes.style.userSelect = "text";
                            pisRes.style.cursor = "text";
                            pisRes.style.marginTop = "5px";
                            pisRes.textContent = response.reply;
                            pisRes.setAttribute("id","clearPrompt");
                            AIboxEl.appendChild(pisRes);
                        } else {
                            const pisRes = document.createElement("p");
                            pisRes.style.color = "#a6ff01";
                            pisRes.style.userSelect = "text";
                            pisRes.style.cursor = "text";
                            pisRes.style.marginTop = "5px";
                            pisRes.textContent = response.reply;
                            AIboxEl.appendChild(pisRes);
                        }
                        const lineBreak = document.createElement("br");
                        lineBreak.style.lineHeight = 2.0;
                        AIboxEl.appendChild(lineBreak);
                    } catch (e) {
                        const pisRes = document.createElement("p");
                        pisRes.style.color = "#a6ff01";
                        pisRes.style.userSelect = "text";
                        pisRes.style.cursor = "text";
                        pisRes.style.marginTop = "5px";
                        pisRes.textContent = `Error: ${e.state}, ${e}`;
                        AIboxEl.appendChild(pisRes);
                    }
                }

                function positionHint() {
                    const Hint = document.getElementById("SRHint");
                    const SRBtn = document.getElementById("startSTT");

                    const rect = SRBtn.getBoundingClientRect();
                    const target_y = rect.top - rect.height / 2 - 10 + 'px';
                    console.log(target_y);

                    Hint.style.top = target_y;
                }

                function stopSTT() {
                    const SRHintTxtEl = document.getElementById("SRHintTxt");
                    const SRHintEl = document.getElementById("SRHint");
                    if (recordState) {
                        console.log("Recording aborted!");
                        medRecorder.stop();
                        recordState = false;
                        modRecordBtn();
                        hideAbort();
                        SRHintTxtEl.textContent = "Press to start recognition";
                        SRHintEl.style.visibility = "hidden";
                        SRBtnEl.addEventListener("mouseout", removeHint);
                        modManIn(false);
                    } else {
                        console.warn("No recording is currently in progress.");
                    }
                }

                function positionAbort() {
                    const abortSTTEl = document.getElementById("abortSTT");
                    const startSTTEl = document.getElementById("startSTT");
                    
                    abortSTTEl.style.left = startSTTEl.offsetLeft;
                    abortSTTEl.style.top = startSTTEl.offsetTop;

                    abortSTTEl.disabled = true;
                    abortSTTEl.style.visibility = "hidden";
                    
                    abortSTTEl.onclick = stopSTT;
                    
                }
                
                let createAlarmInProgress = false;

              	function positionAlarm() {
					const AIboxEl = document.getElementById("AIbox");
					const alarmBoxEl = document.getElementById("alarmBox");
					const alarmPromptEl = document.getElementById("alarmPrompt");
					const createAlarmEl = document.getElementById("createAlarm");
					const alarmsContainerEl = document.getElementById("alarmsContainer");

                    AIboxEl.style.visibility = "visible";
					const target_y = AIboxEl.offsetTop +'px';
					const target_x = (AIboxEl.offsetLeft - alarmBox.offsetWidth) / 2 + 'px';

					alarmPromptEl.style.width = alarmBoxEl.offsetWidth;
					alarmBoxEl.style.top = target_y;
					alarmBoxEl.style.left = target_x;
					createAlarmEl.style.left = alarmPromptEl.offsetLeft + 4 + 'px';
					alarmsContainer.style.height = alarmBoxEl.offsetHeight - alarmPrompt.offsetHeight - 3 + 'px';
					alarmsContainer.style.width = alarmBoxEl.offsetWidth + 'px';
					alarmPrompt.style.top = "0px";
					alarmsContainer.style.top = alarmPrompt.offsetHeight + 'px';
                    AIboxEl.style.visibility = "hidden";

                    createAlarmEl.onclick = handleAlarmBack;

                    positionAIBox();
				}

                function handleAlarmBack() {
                    const alarmsContainerEl = document.getElementById("alarmsContainer");
                        if (createAlarmInProgress === true) {
                            alarmsContainerEl.innerHTML = "";
                            document.getElementById("createImg").src = "src/add.png"
                            createAlarmInProgress = false;
                            // TODO: Add function to enumerate and render through all alarms
                        } else if (createAlarmInProgress === "repeatStage"){
                            createAlarmFunc();
                        } else {
                            createAlarmFunc();
                        }
                }

				function addAlarm(title, hour, minute, repeats) {
					const AIboxEl = document.getElementById("AIbox");
					const alarmBoxEl = document.getElementById("alarmBox");
					
					let previousAlarms = JSON.parse(localStorage.getItem("alarms"));
					if (previousAlarms === null) localStorage.setItem("alarms", []);

					if (repeats.length === 0 || repeats === null) {
						repeats = [];
					}

					const now = new Date();
					
					const alarmId = `${now.getFullYear()}${now.getMonths}${now.getDate()}${now.getHours()}${now.getMinutes()}`;
						
					const payload = {
						name:title,
						time:`${hour}:${minute}`,
						repeat:repeats,
						id: alarmId
					}

					if (previousAlarms.length === 0 || previousAlarms === "") {
						previousAlarms = [];
					}
					
					previousAlarms.push(payload);

					localStorage.setItem("alarms", JSON.stringify(previousAlarms));
				}

				function createAlarmFunc() {
                    createAlarmInProgress = true;
					const promptTextEl = document.getElementById("promptText");
					const alarmImg = document.getElementById("createImg");
					const alarmsContainerEl = document.getElementById("alarmsContainer");
                    const alarmBoxEl = document.getElementById("alarmBox");
                    alarmsContainerEl.style.overflowX = "hidden";   

					promptTextEl.textContent = "Create Alarm";
					alarmImg.src = "src/back.png";
										
					alarmsContainerEl.style.visibility = "visible";
                    alarmsContainerEl.innerHTML = "";
                    alarmsContainerEl.style.width = alarmBoxEl.offsetWidth;
					
                    const timeContainerEl = document.createElement("div");
                    timeContainerEl.style.display = "flex";
                    timeContainerEl.style.flexDirection = "row";
                    timeContainerEl.style.position = "relative";
                    timeContainerEl.style.width = alarmsContainerEl.offsetWidth + 'px';
                    timeContainerEl.style.border = "0.7px solid gray";
                    timeContainerEl.style.backgroundColor = "black";
                    timeContainerEl.style.paddingTop = '3px';
                    timeContainerEl.style.paddingBottom = '3px';
                    const timePrompt = document.createElement("p"); 
                    timePrompt.style.display = "flex";
                    timePrompt.style.alignItems = "center";
                    timePrompt.style.marginLeft = "1em";
                    timePrompt.textContent = "Time";
                    timePrompt.style.backgroundColor = "black";
                    timePrompt.style.width = "4em";
                    timePrompt.style.color = "white";
                    timePrompt.style.height = "2.75em";
                    const timeSelector = document.createElement("input");
                    timeSelector.style.backgroundColor = "white";
                    timeSelector.style.color = "black";
                    const now = new Date();
                    const currentHour = String(now.getHours()).padStart(2,"0");
                    const currentMinute = String(now.getMinutes()).padStart(2,"0");
                    timeSelector.type = "Time";
                    timeSelector.value = `${currentHour}:${currentMinute}`;
                    timeSelector.style.width = "15em";
                    timeSelector.style.position = "absolute";
                    timeSelector.style.right = "1em"; 
                    timeSelector.style.height = "2.75em";
                    timeSelector.style.borderRadius = "2em";
                    timeSelector.style.paddingLeft = "0.5em";
                    timeSelector.style.paddingRight = "0.5em";
                    timeContainerEl.offsetHeight = timeSelector.offsetHeight + 3 + 'px';
                    timeContainerEl.appendChild(timePrompt);
                    timeContainerEl.appendChild(timeSelector);

                    alarmsContainerEl.appendChild(timeContainerEl);

                    const labelContainerEl = document.createElement("div");
                    labelContainerEl.style.display = "flex";
                    labelContainerEl.style.flexDirection = "row";
                    labelContainerEl.style.position = "relative";
                    labelContainerEl.style.width = alarmsContainerEl.offsetWidth + 'px';
                    labelContainerEl.style.border = "0.7px solid gray";
                    labelContainerEl.style.backgroundColor = "black";
                    labelContainerEl.style.paddingTop = '3px';
                    labelContainerEl.style.paddingBottom = '3px';
                    
                    const labelPromptEl = document.createElement("p");
                    labelPromptEl.style.display = "flex";
                    labelPromptEl.style.alignItems = "center";
                    labelPromptEl.style.marginLeft = "1em";
                    labelPromptEl.textContent = "Time";
                    labelPromptEl.style.backgroundColor = "black";
                    labelPromptEl.style.width = "4em";
                    labelPromptEl.style.color = "white";
                    labelPromptEl.style.height = "2.75em";
                    labelPromptEl.textContent = "Label";

                    const labelInput = document.createElement("input");
                    labelInput.style.backgroundColor = "white";
                    labelInput.placeholder = "Alarm";
                    labelInput.style.color = "black";
                    labelInput.style.width = "15em";
                    labelInput.style.position = "absolute";
                    labelInput.style.right = "1em"; 
                    labelInput.style.height = "2.75em";
                    labelInput.style.borderRadius = "2em";
                    labelInput.style.paddingLeft = "1em";

                    labelContainerEl.appendChild(labelPromptEl);
                    labelContainerEl.appendChild(labelInput);
                    alarmsContainerEl.appendChild(labelContainerEl);

                    const repeatContainerEl = document.createElement("div");
                    repeatContainerEl.style.display = "flex";
                    repeatContainerEl.style.flexDirection = "row";
                    repeatContainerEl.style.position = "relative";
                    repeatContainerEl.style.width = alarmsContainerEl.offsetWidth + 'px';
                    repeatContainerEl.style.border = "0.7px solid gray";
                    repeatContainerEl.style.backgroundColor = "black";
                    repeatContainerEl.style.padding = "0 0 0 0";
                    repeatContainerEl.style.height = labelPromptEl.offsetHeight + 'px';

                    const repeatButton = document.createElement("button");
                    repeatButton.style.border = "0px";
                    repeatButton.style.width = alarmsContainerEl.offsetWidth + 6 + 'px';
                    repeatButton.style.backgroundColor = "black";
                    repeatButton.style.cursor = "pointer";
                    repeatButton.style.transition = "background-color 0.2s ease";
                    repeatButton.addEventListener("mouseover", () => {
                        repeatButton.style.backgroundColor = "gray";
                    });
                    repeatButton.addEventListener("mouseout", () => {
                        repeatButton.style.backgroundColor = "black";
                    })
                    repeatButton.style.display = "flex";
                    repeatButton.style.flexDirection = "row";
                    repeatButton.style.color = "white";
                    const repeatPrompt = document.createElement("p");
                    repeatPrompt.style.display = "flex";
                    repeatPrompt.textContent = "Repeat";
                    repeatPrompt.style.alignItems = "center";
                    repeatButton.style.alignItems = "center";               

                    const repeatImg = document.createElement("img");
                    repeatImg.src = "src/enter.png";
                    repeatImg.style.height = "2em";
                    repeatImg.style.width = "2em";
                    repeatImg.style.position = "absolute";
                    repeatImg.style.right = "1px";
                    repeatButton.appendChild(repeatPrompt);
                    repeatButton.appendChild(repeatImg);
                    repeatContainerEl.appendChild(repeatButton);
                    var repeated = [];
                    if (repeated.length === 0) {
                        repeatPrompt.textContent = "Repeat: None"
                    } else {
                        repeatPrompt.textContent = `Repeat: ${repeated.join(", ")}`;
                    }

                    alarmsContainerEl.appendChild(repeatContainerEl);
                }

                function updateClock() {
                    const now = new Date();
                    let hour = now.getHours().toString().padStart(2,"0");
                    let minute = now.getMinutes().toString().padStart(2,"0");

                    const hourEl = document.getElementById("hour");
                    const minuteEl = document.getElementById("minute");

                    hourEl.textContent = hour;
                    minuteEl.textContent = minute;

                    const weekdayEl = document.getElementById("weekday");
                    const dateEl = document.getElementById("date");
                    
                    const weekdays = [
                        "Sun",
                        "Mon",
                        "Tue",
                        "Wed",
                        "Thu",
                        "Fri",
                        "Sat"
                    ]

                    let weekday = now.getDay();
                    let dateRN = now.getDate().toString();

                    weekdayEl.textContent = weekdays[weekday];
                    dateEl.textContent = dateRN;
                }
                function alignClock() {
                    updateClock();
                    const now = new Date();
                    const remainingSecs = 60 - now.getSeconds();
                    setTimeout(() => {
                        updateClock();
                        setInterval(() => {
                            updateClock();
                            positionClock();
                        },60000);
                    }, remainingSecs * 1000);
                }

                function positionClock() {
                    const clockEl = document.getElementById("tc");
                    const greeting = document.getElementById("greeting");

                    const hourEl = document.getElementById("hour");
                    const minuteEl = document.getElementById("minute");
                    const colonEl = document.getElementById("colon"); 

                    clockEl.style.width = (hourEl.offsetWidth + minuteEl.offsetWidth + colonEl.offsetWidth + parseInt(window.getComputedStyle(clockEl).getPropertyValue("padding-left"))) + 'px';

                    const rect = greeting.getBoundingClientRect();
                    clockEl.style.top = rect.bottom + (10 / window.innerHeight) + 'px';
                    clockEl.style.right = rect.left - 3 + 'px';
                }

                function positionWeather() {
                    const greeting = document.getElementById("greeting");
                    const weatherEl = document.getElementById("weather");
                    const weatehrInfoEl = document.getElementById("weatherInfo");

                    const rect = greeting.getBoundingClientRect();
                    weatherEl.style.top = rect.bottom + (10 / window.innerHeight) + 'px';
                }

                async function getLocation() {
                    try {
                        const response = await fetch("https://ipwho.is");                    
                        const data = await response.json();

                        console.log(`Lat: ${data.latitude} Lon: ${data.longitude}`);
                        getWeather(data.latitude, data.longitude);
                    } catch (error) {
                        console.error("Failed to obtain lat and lon from https://ipwho.is: ", error);
                    }


                }

                async function getWeather(lat, lon) {
                    const codes = { 0: "clear", 1: "mostly clear", 2: "partly cloudy", 3: "overcast", 45: "foggy", 48: "foggy", 51: "light drizzle", 61: "rain", 80: "rain showers", 95: "thunderstorm" };
                    try {
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const data = await response.json();

                        const temp = data.current_weather.temperature.toString();
                        const code = codes[data.current_weather.weathercode];
                        const tempUnit = data.current_weather_units.temperature;
                        console.log(data)

                        const tempEl = document.getElementById("temp");
                        const weatherText = document.getElementById("weatherText");
                        const weatherData = document.getElementById("weatherData");

                        tempEl.textContent = temp + tempUnit;
                        weatherText.textContent = code;
                        weatherData.src = `src/${code}.png`

                        console.log(temp,tempUnit," ",code,);
                        localStorage.setItem("weatherData",JSON.stringify(data));
                    } catch (e) {
                        console.log(`Failed to get weather: ${e}`);
                    }
                }
				
                function initApp() {

                    setInterval(getLocation, 3600000);
                    let userName = localStorage.getItem("username");
                    requestMic();
                    if (!userName) {
                        showSetup();
                        return;
                    } else {
                        const greetingEl = document.getElementById("greeting");
                        greetingEl.textContent = `Welcome back, ${userName}!`;
                        positionHint();
                        alignClock();
                        positionClock();
                        positionWeather();
                        getLocation();
                        positionManIn();
                        positionAbort();
                        positionAIBox();
						positionAlarm();
                    }
                }

                function showSetup() {
                    const setupEl = document.getElementById("setUp-container");
                    setupEl.style.visibility = "visible";
                    document.body.classList.add("blur-active");
                    const setupInputEl = document.getElementById("setup-input");
                    setupInputEl.focus();
                }

                function setupDone() {
                    const inputEl = document.getElementById("setup-input");
                    const warningTxt = document.getElementById("setup-warning");
                    const username = inputEl.value.trim();

                    if (!username) {
                        inputEl.focus();
                        warningTxt.textContent = "Please enter a name";
                        warningTxt.style.visibility = "visible";
                        return;
                    } else {
                        const setupEl = document.getElementById("setUp-container");
                        const greetingEl = document.getElementById("greeting");
                        localStorage.setItem("username",username);
                        greetingEl.textContent = `Welcome back, ${username}!`;
                        setupEl.style.visibility = "hidden";
                        warningTxt.style.visibility = "hidden"
                        document.body.classList.remove("blur-active");
                        positionHint();
                        alignClock();
                        positionClock();
                        positionWeather();
                        getLocation();
                        positionManIn();
                        positionAbort();
                        positionAIBox();
						positionAlarm();
                        return;
                    }
                }

                function redirectToGitHub() {
                    window.open("https://github.com/milo1004","_blank");
                }

                document.fonts.ready.then(() => {
                    document.body.style.visibility = "visible";
                    initApp();
                });
            </script>
        </body>
    </html>
